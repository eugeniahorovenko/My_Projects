# Документація SQL-запитів для аналізу даних

## Запит 1: Аналіз метрик електронної пошти в розрізі країн

### Загальний опис
Цей SQL-запит призначений для комплексного аналізу ефективності електронних листів та активності аккаунтів у розрізі різних країн. Запит дозволяє визначити топ-10 країн за кількістю аккаунтів та кількістю відправлених повідомлень, з детальним розбиттям метрик за датами, інтервалами відправлення та статусами користувачів.

### Логіка виконання запиту

Запит складається з шести послідовних етапів обробки даних:

1. **Створення таблиці `email_metrics` через WITH**:
   - Збирає детальну інформацію про електронні листи, їх відкриття та переходи
   - Об'єднує таблиці `DA.email_sent`, `DA.account_session`, `DA.account`, `DA.session`, `DA.session_params`, `DA.email_open` та `DA.email_visit`
   - Розраховує дату з урахуванням зміщення (DATE_ADD)
   - Групує дані за датою, країною, інтервалом відправлення та статусами верифікації/відписки
   - Підраховує кількість унікальних повідомлень (відправлених, відкритих, з переходами)

2. **Створення таблиці `account_information` через WITH**:
   - Збирає інформацію про кількість аккаунтів 
   - Об'єднує таблиці `DA.account_session`, `DA.account`, `DA.session` та `DA.session_params`
   - Використовує ті ж групувальні поля для забезпечення можливості подальшого об'єднання даних

3. **Об'єднання даних у таблиці `union_table` через WITH**:
   - Використовує UNION ALL для об'єднання даних з `email_metrics` та `account_information`
   - Заповнює відсутні метрики нулями для забезпечення коректного формату даних
   - Зберігає всі параметри для подальшої агрегації

4. **Агрегація даних у таблиці `select_table_1` через WITH**:
   - Сумує значення метрик для кожної унікальної комбінації параметрів
   - Забезпечує коректне об'єднання даних після UNION ALL

5. **Розрахунок загальних показників у таблиці `select_table_2` через WITH**:
   - Використовує віконні функції (SUM OVER) для розрахунку загальної кількості аккаунтів та відправлених повідомлень по кожній країні
   - Створює основу для подальшого ранжування країн

6. **Фінальна підготовка даних у таблиці `final_select` через WITH**:
   - Додає ранжування країн за допомогою віконної функції DENSE_RANK()
   - Забезпечує збереження однакових рангів для країн з однаковими показниками

7. **Фінальний запит**:
   - Вибирає всі необхідні поля з таблиці `final_select`
   - Застосовує фільтр для вибору тільки топ-10 країн за кількістю аккаунтів або за кількістю відправлених повідомлень

### Використані таблиці

1. **`DA.email_sent`** - містить інформацію про відправлені електронні листи:
   - id_message: унікальний ідентифікатор повідомлення
   - id_account: ідентифікатор аккаунта отримувача
   - sent_date: дата відправлення (використовується для розрахунку фактичної дати)

2. **`DA.email_open`** - містить інформацію про відкриті електронні листи:
   - id_message: ідентифікатор відкритого повідомлення

3. **`DA.email_visit`** - містить інформацію про переходи за посиланнями в листах:
   - id_message: ідентифікатор повідомлення, за посиланням в якому був здійснений перехід

4. **`DA.account_session`** - зв'язує аккаунти з сесіями:
   - account_id: ідентифікатор аккаунта
   - ga_session_id: ідентифікатор сесії

5. **`DA.account`** - містить інформацію про аккаунти користувачів:
   - id: унікальний ідентифікатор аккаунта
   - send_interval: інтервал відправки повідомлень
   - is_verified: статус верифікації аккаунта
   - is_unsubscribed: статус відписки від розсилки

6. **`DA.session`** - містить інформацію про сесії:
   - ga_session_id: унікальний ідентифікатор сесії
   - date: дата сесії

7. **`DA.session_params`** - містить параметри сесій:
   - ga_session_id: ідентифікатор сесії
   - country: країна, з якої була здійснена сесія

### Поля результуючої таблиці

- **date** - дата (з урахуванням зміщення для відправлених повідомлень)
- **country** - країна користувача
- **send_interval** - інтервал відправки повідомлень
- **is_verified** - статус верифікації аккаунта (1 - верифікований, 0 - неверифікований)
- **is_unsubscribed** - статус відписки (1 - відписаний, 0 - підписаний)
- **account_cnt** - кількість унікальних аккаунтів
- **sent_msg** - кількість унікальних відправлених повідомлень
- **open_msg** - кількість унікальних відкритих повідомлень
- **visit_msg** - кількість унікальних повідомлень з переходами за посиланнями
- **total_country_account_cnt** - загальна кількість аккаунтів у країні (сума по всіх датах та інших параметрах)
- **total_country_sent_cnt** - загальна кількість відправлених повідомлень у країні (сума по всіх датах та інших параметрах)
- **rank_total_country_account_cnt** - ранг країни за загальною кількістю аккаунтів (1 - найбільша кількість)
- **rank_total_country_sent_cnt** - ранг країни за загальною кількістю відправлених повідомлень (1 - найбільша кількість)

### Особливості запиту

1. **Структура з використанням WITH**:
   - Розбиття на проміжні таблиці значно підвищує читабельність і модульність запиту
   - Дозволяє поетапно трансформувати дані, полегшуючи налагодження і модифікацію

2. **Використання UNION ALL для об'єднання різних метрик**:
   - Забезпечує гнучкість у роботі з даними, що мають різну структуру
   - Дозволяє агрегувати різні типи метрик в одній результуючій таблиці

3. **Застосування віконних функцій для аналітики**:
   - SUM OVER для розрахунку загальних показників по країнах
   - DENSE_RANK для ефективного ранжування країн з врахуванням однакових значень

4. **Фільтрація за рангом для виділення топ-країн**:
   - Умова `WHERE rank_total_country_account_cnt <=10 OR rank_total_country_sent_cnt <=10` дозволяє отримати тільки найбільш значущі дані
   - Логічний оператор OR забезпечує включення країн, що входять хоча б в один із топів

5. **Коректне врахування дати відправлення**:
   - Використання `DATE_ADD(s.date, INTERVAL es.sent_date DAY)` для точного визначення фактичної дати відправлення

--

## Запит 2: Аналіз доходу за континентами

### Загальний опис
Цей SQL-запит призначений для комплексного аналізу доходу та активності користувачів у розрізі континентів. Запит не тільки вираховує загальний дохід, але й розбиває його за типами пристроїв (мобільний та десктоп), а також надає детальну інформацію про кількість сесій, аккаунтів та верифікованих аккаунтів. Додатково розраховуються відсоткові співвідношення для аналізу внеску кожного континенту в загальний дохід.

### Логіка виконання запиту

Запит складається з трьох основних етапів:

1. **Створення таблиці `revenue_usd` через WITH**:
   - Збирає та аналізує дані про дохід у розрізі континентів
   - Розділяє дохід за типами пристроїв (мобільний та десктоп) за допомогою умовного агрегування
   - Об'єднує таблиці `DA.order`, `DA.product` та `DA.session_params`
   - Використовує SUM з умовами CASE WHEN для розділення доходу за типами пристроїв
   - Групує дані за континентами для подальшого аналізу

2. **Створення таблиці `acc_information` через WITH**:
   - Збирає детальну інформацію про сесії, аккаунти та їх статуси
   - Розраховує загальну кількість сесій та аккаунтів
   - Окремо підраховує кількість верифікованих аккаунтів за допомогою умовного агрегування
   - Об'єднує таблиці `DA.session_params`, `DA.account_session` та `DA.account`
   - Використовує LEFT JOIN для включення всіх сесій, навіть якщо вони не пов'язані з аккаунтами
   - Групує дані за континентами для збереження однакової структури з першою таблицею

3. **Фінальний запит**:
   - Об'єднує дані з таблиць `revenue_usd` та `acc_information` за полем континенту за допомогою LEFT JOIN
   - Розраховує відсоткові показники внеску кожного континенту в загальний дохід
   - Використовує віконні функції (SUM OVER()) для розрахунку загального доходу та відсотків

### Використані таблиці

1. **`DA.order`** - містить інформацію про замовлення:
   - item_id: ідентифікатор товару
   - ga_session_id: ідентифікатор сесії, в рамках якої було здійснено замовлення

2. **`DA.product`** - містить інформацію про товари:
   - item_id: унікальний ідентифікатор товару
   - price: ціна товару в USD

3. **`DA.session_params`** - містить параметри сесій:
   - ga_session_id: унікальний ідентифікатор сесії
   - continent: континент, з якого була здійснена сесія
   - device: тип пристрою (mobile або desktop)

4. **`DA.account_session`** - зв'язує аккаунти з сесіями:
   - ga_session_id: ідентифікатор сесії
   - account_id: ідентифікатор аккаунта, пов'язаного з сесією

5. **`DA.account`** - містить інформацію про аккаунти користувачів:
   - id: унікальний ідентифікатор аккаунта
   - is_verified: статус верифікації аккаунта (використовується для підрахунку верифікованих аккаунтів)

### Поля результуючої таблиці

- **continent** - континент користувача
- **revenue** - загальний дохід з континенту 
- **revenue_from_mobile** - дохід від замовлень з мобільних пристроїв
- **revenue_from_desktop** - дохід від замовлень з десктопних пристроїв
- **revenue_from_total** - відсоток доходу з континенту від загального доходу (%)
- **mobile_revenue_from_total** - відсоток доходу з мобільних пристроїв континенту від загального доходу (%)
- **desktop_revenue_from_total** - відсоток доходу з десктопних пристроїв континенту від загального доходу (%)
- **session_cnt** - кількість унікальних сесій з континенту
- **account_cnt** - кількість унікальних аккаунтів з континенту
- **verified_account** - кількість верифікованих аккаунтів з континенту

### Особливості запиту

1. **Ефективне використання WITH для структурування запиту**:
   - Дозволяє логічно розділити збір даних про дохід та інформацію про аккаунти
   - Підвищує читабельність та спрощує подальшу модифікацію

2. **Умовне агрегування через CASE WHEN**:
   - В таблиці `revenue_usd` використовується для розділення доходу за типами пристроїв
   - В таблиці `acc_information` застосовується для підрахунку тільки верифікованих аккаунтів

3. **Використання LEFT JOIN для збереження всіх даних**:
   - У фінальному запиті забезпечує включення всіх континентів, навіть якщо для них немає даних про дохід
   - В таблиці `acc_information` гарантує включення всіх сесій, навіть без прив'язки до аккаунтів

4. **Обчислення відносних показників за допомогою віконних функцій**:
   - SUM OVER() використовується для розрахунку загального значення по всіх континентах

5. **Чітке розділення між різними типами пристроїв**:
   - Дозволяє аналізувати ефективність мобільних та десктопних каналів продажів
   - Надає можливість виявити континенти з високою часткою мобільних або десктопних продажів

--

## Запит 3: Аналіз метрик електронної пошти за операційними системами

### Загальний опис
Цей SQL-запит призначений для аналізу ефективності електронних листів у розрізі операційних систем користувачів. Запит збирає дані про відправлені листи, їх відкриття та переходи за посиланнями, а також розраховує ключові метрики ефективності: відсоток відкриття (open rate), відсоток переходів за посиланнями (click rate) та відношення переходів до відкриттів (CTOR - Click-to-Open Rate).

### Логіка виконання запиту

Запит складається з двох основних етапів:

1. **Створення таблиці `email_metrics` через WITH**:
   - Збирає базову інформацію про електронні листи (відправлені, відкриті, з переходами)
   - Об'єднує таблиці `DA.email_sent`, `DA.account_session`, `DA.account`, `DA.email_open` та `DA.email_visit`
   - Використовує LEFT JOIN для включення всіх відправлених листів, навіть якщо вони не були відкриті або за ними не було переходів
   - Зберігає ідентифікатори повідомлень та сесій для подальшого аналізу

2. **Фінальний запит**:
   - Об'єднує дані з тимчасової таблиці `email_metrics` з таблицею `DA.session_params` для отримання інформації про операційну систему
   - Фільтрує дані, виключаючи користувачів, які відписалися (is_unsubscribed = 0)
   - Групує результати за операційною системою
   - Розраховує три ключові метрики ефективності:
     - Open Rate: відсоток відкритих листів від загальної кількості відправлених
     - Click Rate: відсоток листів з переходами від загальної кількості відправлених
     - CTOR (Click-to-Open Rate): відсоток листів з переходами від кількості відкритих

### Використані таблиці

1. **`DA.email_sent`** - містить інформацію про відправлені електронні листи:
   - id_message: унікальний ідентифікатор повідомлення
   - id_account: ідентифікатор аккаунта отримувача

2. **`DA.email_open`** - містить інформацію про відкриті електронні листи:
   - id_message: ідентифікатор відкритого повідомлення

3. **`DA.email_visit`** - містить інформацію про переходи за посиланнями в листах:
   - id_message: ідентифікатор повідомлення, за посиланням в якому був здійснений перехід

4. **`DA.account_session`** - зв'язує аккаунти з сесіями:
   - account_id: ідентифікатор аккаунта
   - ga_session_id: ідентифікатор сесії

5. **`DA.account`** - містить інформацію про аккаунти користувачів:
   - id: унікальний ідентифікатор аккаунта
   - is_unsubscribed: статус відписки (використовується для фільтрації)

6. **`DA.session_params`** - містить параметри сесій:
   - ga_session_id: ідентифікатор сесії
   - operating_system: операційна система користувача

### Поля результуючої таблиці

- **operating_system** - операційна система користувача
- **open_msg** - кількість унікальних відкритих повідомлень
- **sent_msg** - кількість унікальних відправлених повідомлень
- **vist_msg** - кількість унікальних повідомлень з переходами за посиланнями
- **open_rate** - відсоток відкриття (кількість відкритих / кількість відправлених * 100)
- **click_rate** - відсоток переходів (кількість з переходами / кількість відправлених * 100)
- **ctor** - відношення переходів до відкриттів (кількість з переходами / кількість відкритих * 100)

### Особливості запиту

1. **Використання WITH для проміжної таблиці**:
   - Спрощує структуру запиту та підвищує його читабельність
   - Дозволяє уникнути повторення складних JOIN конструкцій
   - Полегшує налагодження та модифікацію запиту

2. **Фільтрація за статусом відписки**:
   - Запит аналізує тільки дані користувачів, які не відписалися від розсилки (is_unsubscribed = 0)
   - Це дозволяє отримати більш точні метрики ефективності для активної аудиторії

3. **Використання COUNT DISTINCT**:
   - Забезпечує підрахунок тільки унікальних повідомлень
   - Допомагає уникнути дублювання даних, якщо одне повідомлення було відкрито або за ним був здійснений перехід кілька разів

4. **Розрахунок відносних метрик**:
   - Відсоткові значення (open_rate, click_rate, ctor) дозволяють порівнювати ефективність розсилок між різними операційними системами

5. **Ефективне використання JOIN для зв'язування різних джерел даних**:
   - JOIN в першій частині об'єднує дані про листи та аккаунти
   - JOIN у фінальному запиті додає інформацію про операційні системи
